Add â€œTheory Modeâ€ with Offline Model Worlds (Advanced Investments Lab)
Goal

Augment the existing â€œAdvanced Investments Interactive Labâ€ so users can see models and theory working without relying on APIs or their current portfolio. Add a global Theory/Practice toggle. In Theory Mode, provide six offline â€œModel Worldsâ€ (synthetic/curated datasets) that manifest the lecture ideas clearly. Reuse the same charts and metrics as Practice Mode, but power them with generated or bundled data.

High-Level Requirements

Global toggle in the header: Theory Mode / Practice Mode

In Theory Mode, show a â€œModel Worldsâ€ landing page with six tiles:

CAPM World

FF-5(+MOM) World (Anomalies/Multi-factor)

LPM / Higher-Moments World

Utility & SDF World

Term & Credit (Fixed Income) World

Risk-Neutral (Options) World

Each World has:

Left panel: â€œTheory Cardâ€ (equations + assumptions), â€œKnobsâ€ (sliders/inputs), a Generate button (fixed seed for reproducibility), and Reset.

Right panel: Charts + Tables that mirror existing Practice module visuals (frontier, SML, factor tables, heatmaps, QQ plots, LPM surfaces, yield curve, etc.), plus a short â€œWhat this showsâ€ tooltip on each chart.

Ship with a /data/casepacks/ folder: small CSVs for demo runs (so everything works offline out-of-the-box).

No external API calls required in Theory Mode.

Tech/Structure (reuse existing stack)

Frontend: Next.js (App Router) + React + Tailwind + Plotly

Backend: FastAPI (Python)

Math/Data: numpy, pandas, scipy, statsmodels, (optional) cvxpy / PyPortfolioOpt for frontiers

Create new backend modules:

/backend/theory/
  generators.py          # synthetic data generators for each World
  capm_world.py          # wrappers that produce returns, betas, expected returns, etc.
  ff_world.py
  lpm_world.py
  utility_world.py
  fixed_income_world.py
  risk_neutral_world.py
  diagnostics.py         # NW SEs, block bootstrap, QQ points, LPM surfaces


Create new frontend pages/components:

/frontend/app/theory/page.tsx            # Worlds landing
/frontend/app/theory/[world]/page.tsx    # World detail pages (capm, ff, lpm, utility, fixed-income, risk-neutral)
/frontend/components/theory/KnobsPanel.tsx
/frontend/components/theory/TheoryCard.tsx
/frontend/components/shared/ExplainTip.tsx
/frontend/components/charts/*            # reuse: FrontierChart, SMLPlot, FactorHeatmap, LPMHeatmap, QQPlot, YieldCurvePlot, etc.

Data & UI Conventions

All generated data are monthly unless otherwise specified (set slider for T=120 default).

Annualization: clearly display assumptions (e.g., multiply monthly mean by 12, vol by âˆš12).

Provide Export buttons: CSV for series/tables; PNG for charts.

World 1 â€” CAPM World (Lectures 1â€“2)

Purpose: See CML/SML, beta pricing, Famaâ€“MacBeth, and (optionally) GRS cleanly under correct specification.

Knobs (defaults in brackets):

Number of assets K [25], Sample length T months [120]

Risk-free 
ğ‘Ÿ
ğ‘“
r
f
	â€‹

 [0.02 annual], Market mean Î¼_M [0.06], Market vol Ïƒ_M [0.16]

Beta dispersion std [0.4], Idiosyncratic vol range [0.10â€“0.25]

Random seed [42]

Generator (backend):

Draw factors: 
ğ‘“
ğ‘€
,
ğ‘¡
âˆ¼
ğ‘
(
ğœ‡
ğ‘€
/
12
,
Â 
(
ğœ
ğ‘€
/
12
)
2
)
f
M,t
	â€‹

âˆ¼N(Î¼
M
	â€‹

/12,Â (Ïƒ
M
	â€‹

/
12
	â€‹

)
2
).

Draw true betas 
ğ›½
ğ‘–
âˆ¼
ğ‘
(
1
,
ğœ
ğ›½
2
)
Î²
i
	â€‹

âˆ¼N(1,Ïƒ
Î²
2
	â€‹

), idio vol per asset 
ğœ
ğœ€
,
ğ‘–
Ïƒ
Îµ,i
	â€‹

.

Returns: 
ğ‘Ÿ
ğ‘–
,
ğ‘¡
=
ğ‘Ÿ
ğ‘“
/
12
+
ğ›½
ğ‘–
ğ‘“
ğ‘€
,
ğ‘¡
+
ğœ€
ğ‘–
,
ğ‘¡
r
i,t
	â€‹

=r
f
	â€‹

/12+Î²
i
	â€‹

f
M,t
	â€‹

+Îµ
i,t
	â€‹

, 
ğœ€
ğ‘–
,
ğ‘¡
âˆ¼
ğ‘
(
0
,
ğœ
ğœ€
,
ğ‘–
2
/
12
)
Îµ
i,t
	â€‹

âˆ¼N(0,Ïƒ
Îµ,i
2
	â€‹

/12).

Outputs (frontend):

Efficient frontier + CML + Tangency (Markowitz on generated assets)

SML plot: 
ğ¸
[
ğ‘Ÿ
ğ‘–
]
E[r
i
	â€‹

] vs estimated 
ğ›½
ğ‘–
Î²
i
	â€‹

; table with 
ğ›¼
,
ğ›½
,
ğ‘¡
Î±,Î²,t, 
ğ‘…
2
R
2
 (NW SEs)

Famaâ€“MacBeth: cross-sectional price of risk 
ğœ†
^
ğ‘€
Î»
^
M
	â€‹

 and t-stat

(Optional) GRS joint-alpha test on K assets vs CAPM factor

ExplainTip examples:

â€œUnder CAPM, assets lie on the SML; distance = alpha.â€

World 2 â€” FF-5(+MOM) World (Lecture 3)

Purpose: Show multi-factor pricing, RÂ² improvement vs CAPM, loadings heatmap.

Knobs:

K assets [25], T [240], Factors included: MKT, SMB, HML, RMW, CMA, (MOM optional)

Factor means (annual) & covariance matrix (UI seeds with reasonable values)

Beta structure: choose patterns (e.g., small stocks load +SMB), add noise

Omit-factor checkbox (to create alphas intentionally)

Seed [43]

Generator:

ğ‘“
ğ‘¡
âˆ¼
ğ‘
(
ğœ‡
ğ‘“
/
12
,
Â 
Î£
ğ‘“
/
12
)
f
t
	â€‹

âˆ¼N(Î¼
f
	â€‹

/12,Â Î£
f
	â€‹

/12)

Asset returns: 
ğ‘Ÿ
ğ‘–
,
ğ‘¡
=
ğ‘Ÿ
ğ‘“
/
12
+
ğ›½
ğ‘–
âŠ¤
ğ‘“
ğ‘¡
+
ğœ€
ğ‘–
,
ğ‘¡
r
i,t
	â€‹

=r
f
	â€‹

/12+Î²
i
âŠ¤
	â€‹

f
t
	â€‹

+Îµ
i,t
	â€‹


Outputs:

Factor premia (sample means), correlation heatmap

Loadings table (betas + t-stats)

RÂ² comparison: CAPM vs Multi-factor (bar chart of RÂ² by asset)

Highlight alphas when a relevant factor is omitted

ExplainTip:

â€œAdding priced factors raises RÂ² and should shrink alphas if the model is correctly specified.â€

World 3 â€” LPM / Higher-Moments World (Lecture 4)

Purpose: Demonstrate non-normality, LPM vs variance, semivariance frontier.

Knobs:

Distribution: Mixture Normal (weights, Î¼1, Ïƒ1, Î¼2, Ïƒ2) or Skew-t (df, skew)

ğœ
Ï„ threshold [0 or 
ğ‘Ÿ
ğ‘“
/
12
r
f
	â€‹

/12], order 
ğ‘›
âˆˆ
{
1
,
2
,
3
}
nâˆˆ{1,2,3} [2]

Number of assets [10]; correlation between assets [0.3]

T [240], seed [44]

Generator:

Simulate returns per chosen distribution; induce correlation via Cholesky on Î£.

Outputs:

Histogram + QQ plot, skew/kurtosis/JB

LPM surface heatmap over grid of 
ğœ
,
ğ‘›
Ï„,n

Frontier comparison: MV vs Semivariance (n=2, Ï„ choice)

Co-LPM beta vs covariance beta for a chosen benchmark

ExplainTip:

â€œWhen left tails are fat, variance underestimates downside. LPM focuses only on below-threshold losses.â€

World 4 â€” Utility & SDF World (Lecture 5)

Purpose: Connect preferences to state prices and the pricing equation 
1
=
ğ¸
[
ğ‘š
ğ‘…
]
1=E[mR].

Knobs:

Utility: CRRA, CARA, DARA; risk aversion Î³ [3], discount Î² [0.99]

Simulate consumption growth Î”log c ~ Normal(Î¼_c, Ïƒ_c) or AR(1); correlation with asset returns [-0.3 to +0.3]

Two assets with configurable comovement w.r.t. consumption (one â€œrecession hedgeâ€)

T [240], seed [45]

Generator:

Build consumption path; compute SDF 
ğ‘š
ğ‘¡
âˆ
ğ›½
ğ‘ˆ
â€²
(
ğ‘
ğ‘¡
+
1
)
ğ‘ˆ
â€²
(
ğ‘
ğ‘¡
)
m
t
	â€‹

âˆÎ²
U
â€²
(c
t
	â€‹

)
U
â€²
(c
t+1
	â€‹

)
	â€‹


Simulate asset returns correlated with consumption

Outputs:

Plots: U(x), Uâ€²(x) (given Î³); SDF path; state weighting

Pricing identity: compute 
Î”
=
1
âˆ’
ğ¸
[
ğ‘š
ğ‘…
]
Î”=1âˆ’E[mR] for each asset (should be ~0 if priced)

Overlay CAPM SDF (affine in market return) vs utility-based SDF (shape comparison)

ExplainTip:

â€œRisk aversion implies higher state prices in bad times; assets paying in recessions need lower average returns.â€

World 5 â€” Term & Credit (Fixed Income) World (Lecture 6)

Purpose: Yield curves, term spreads, credit premiaâ€”fully offline.

Knobs:

Yield curve entry: user inputs 3â€“5 points (e.g., 3m, 2y, 10y) per scenario; or choose presets (Normal, Steep, Inverted)

Fit Nelsonâ€“Siegelâ€“Svensson curve; animate over dates (slider)

Credit: rating bucket OAS levels; downgrade probability

Seed [46]

Generator:

Use NSS to produce smooth curves; compute term spread (10yâ€“3m)

Create synthetic bond baskets and credit spread paths via OAS + downgrades

Outputs:

Yield curve plot (per date), term spread time series, credit spread series

Example 5-factor SDF schematic across stocks+bonds (Market, SMB, HML, TERM, CREDIT)

Sensitivity: bond price change for Â±100 bps shock

ExplainTip:

â€œTerm and credit are bond risk premia that extend the equity factor story into fixed income.â€

World 6 â€” Risk-Neutral (Options) World (Lecture 6)

Purpose: Intuition for Q vs P measures and risk-neutral probabilities.

Knobs:

Binomial mode: S, u, d, r, T=1 step

BS sandbox: S, K, r, T, Ïƒ (educational only)

Seed [47]

Generator/Calcs:

Binomial: solve 
ğ‘
ğ‘„
p
Q
	â€‹

 so that 
ğ¸
ğ‘„
[
ğ‘…
]
=
ğ‘Ÿ
ğ‘“
E
Q
[R]=r
f
	â€‹

; price call

BS: compute call price and show implied state prices visualization

Outputs:

State payoff diagram, 
ğ‘
ğ‘„
p
Q
	â€‹

, call value

Comparison: physical vs risk-neutral expectation

ExplainTip:

â€œUnder Q, expected return equals 
ğ‘Ÿ
ğ‘“
r
f
	â€‹

; option prices encode state prices.â€

Backend API (Theory Mode)

Create new endpoints (FastAPI) under /api/theory/*:

POST /api/theory/capm/generate
Body: {K,T,rf,mu_mkt,sigma_mkt,beta_dispersion,idio_vol_min,idio_vol_max,seed}
Return: {assets: {id, series: [{date, ret}]...}, market: [...], rf, est: {betas, alphas, tvals, r2}, frontier, cml, tangency, fmb:{lambda,t}, grs?:{F,p}}

POST /api/theory/ff/generate
Body includes selected factors, means, cov, K, T, beta pattern, omit_flags, seed
Return: {factors:{name,series}, assets:{...}, loadings:{...}, alpha_table, r2_capm, r2_multifactor, corr_heatmap}

POST /api/theory/lpm/generate
Body: {dist:"mixture"|"skewt", params:{...}, K,T, corr, tau, n, seed}
Return: {assets, stats:{skew,kurt,jb,qq}, lpm_surface, mv_frontier, sv_frontier, beta_cov, beta_colpm}

POST /api/theory/utility/generate
Body: {utility:"CRRA"|"CARA"|"DARA", gamma, beta, cons:{type:"iid"|"ar1", params}, assets:{count, corr_with_c}, T, seed}
Return: {U_curve, Uprime_curve, sdf_series, pricing_errors, capm_sdf_overlay}

POST /api/theory/fixedincome/generate
Body: {curve_points:[{tenor,yield}], presets?, animate?:{dates, n}, credit:{oas_by_rating, downgrade_prob}, seed}
Return: {curve_series, term_spread_series, credit_spread_series, shock_sensitivity}

POST /api/theory/riskneutral/generate
Body: {mode:"binomial"|"bs", params:{...}}
Return: {p_q, call_value, state_prices_plot_points}

Diagnostics helpers (/api/theory/diagnostics/*):

Neweyâ€“West SEs, block bootstrap CIs, QQ points, LPM grid

Casepacks (bundle offline CSVs)

Under /data/casepacks/ include:

capm_demo.csv (market & 15 assets, monthly 10 years)

ff_demo.csv (factors + 20 synthetic assets)

lpm_demo.csv (skewed returns for 8 assets)

utility_demo.csv (consumption path + 2 asset returns)

yield_demo.csv (a few dated curves), credit_demo.csv (spread path)

rn_demo.csv (toy parameters)

Each World can Load Demo to bypass generation.

Frontend UX Details

Header switch: Practice | Theory (persist in local storage)

Theory landing: six tiles with short 1-line purpose + â€œOpenâ€

World page layout:
Left column: Theory Card (markdown), KnobsPanel, Generate / Reset
Right column: charts + tables with ExplainTip icon

Exports: CSV (series/tables), PNG (charts)

Accessibility: tab order, aria labels, keyboard toggles

Acceptance Criteria

I can switch to Theory Mode, open CAPM World, click Generate, and immediately see: frontier + CML + SML + Î±/Î² table + Famaâ€“MacBeth results (no internet).

In FF-5 World, I can toggle factors and see RÂ² rise vs CAPM, with a loadings heatmap and factor premia table.

In LPM World, selecting a skewed distribution makes the JB test reject normality, the LPM surface display, and the semivariance frontier differ from MV.

In Utility World, changing Î³ updates U, Uâ€², the SDF path, and the pricing error 
1
âˆ’
ğ¸
[
ğ‘š
ğ‘…
]
1âˆ’E[mR].

In Fixed-Income World, I can enter 3â€“5 yields, fit a curve, view term spread, and see bond P&L for a Â±100 bps shock.

In Risk-Neutral World, I can set (S,u,d,r) and get p_Q and call price with a state-price visualization.

Non-Functional

Offline-first: no API calls in Theory Mode.

Deterministic via seeds; document annualization.

Clear validation messages for knob inputs.

Unit tests for generators: dimensions, moments (approx), regression recovery under correct spec.